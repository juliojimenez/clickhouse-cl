name: CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SBCL_PATH: /home/runner/.roswell/impls/x86-64/linux/sbcl-bin/2.3.1/bin

jobs:
  all_tests_suite:
    name: All Tests Suite
    runs-on: ubuntu-latest
    services: 
      clickhouse:
        image: clickhouse/clickhouse-server
        ports:
          - 8123:8123
        options: --ulimit nofile=262144:262144

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Roswell
        env:
          LISP: sbcl-bin
        run: curl -L https://raw.githubusercontent.com/roswell/roswell/master/scripts/install-for-ci.sh | sh

      - name: Env Setup 
        run: |
          find /home/runner -name asdf.lisp -print
          curl -o /tmp/ql.lisp http://beta.quicklisp.org/quicklisp.lisp
          $SBCL_PATH/sbcl --non-interactive --no-sysinit --no-userinit --load /tmp/ql.lisp \
            --eval '(quicklisp-quickstart:install :path "/home/runner/.quicklisp")' \
            --eval '(ql:add-to-init-file)' \
            --quit
          $SBCL_PATH/sbcl --eval '(asdf:test-system "clickhouse-test")'
        
